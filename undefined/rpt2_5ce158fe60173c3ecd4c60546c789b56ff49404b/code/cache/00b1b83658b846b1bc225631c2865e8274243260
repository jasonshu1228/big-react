{"code":"import { NoFlags } from './fiberFlags';\r\nimport { appendInitialChild, createInstance, createTextInstance } from 'hostConfig';\r\nimport { HostComponent, HostText, HostRoot } from './workTags';\r\nexport const completeWork = (wip) => {\r\n    // 递归中的归\r\n    const newProps = wip.pendingProps;\r\n    const current = wip.alternate;\r\n    switch (wip.tag) {\r\n        case HostComponent:\r\n            if (current !== null && wip.stateNode) {\r\n                // update 阶段\r\n            }\r\n            else {\r\n                // mount 阶段\r\n                // 1.构建DOM\r\n                // 浏览器环境就是DOM节点，原生开发就是原生native组件\r\n                // const instance = createInstance(wip.type, newProps);\r\n                const instance = createInstance(wip.type);\r\n                // 2.将DOM插入到DOM树中，这步其实也就是将刚才递归遍历的DOM树，都挂载在统一的dom上\r\n                // 也就是构建离谱DOM树\r\n                appendAllChildren(instance, wip);\r\n                wip.stateNode = instance;\r\n            }\r\n            // 冒泡子树副作用标识\r\n            bubblePropertied(wip);\r\n            return null;\r\n        case HostText:\r\n            if (current !== null && wip.stateNode) {\r\n                // update 阶段\r\n            }\r\n            else {\r\n                // mount 阶段\r\n                // 1.构建DOM\r\n                // 浏览器环境就是DOM节点，原生开发就是原生native组件\r\n                const instance = createTextInstance(newProps.content); // newProps.conten： string || number\r\n                // 将文本属性生成的实例挂载在文本节点上\r\n                wip.stateNode = instance;\r\n                // 文本节点不存在 child\r\n            }\r\n            bubblePropertied(wip);\r\n            return null;\r\n        case HostRoot:\r\n            bubblePropertied(wip);\r\n            return null;\r\n        default:\r\n            if (true) {\r\n                console.warn('未处理的completeWork情况', wip);\r\n            }\r\n            break;\r\n    }\r\n};\r\n/*\r\n    <A>123</A>\r\n\n    <h1>\r\n        <A />\r\n        <A />\r\n    </h1>\r\n*/\r\n// 往 parent 节点中插入 wip，但有可能 wip 不是单独的元素，还有可能是组件，比如上面的情况\r\nfunction appendAllChildren(parent, wip) {\r\n    let node = wip.child;\r\n    while (node !== null) {\r\n        // 首先向下找\r\n        if (node.tag === HostComponent || node.tag === HostText) {\r\n            // 找到了就可以插入\r\n            appendInitialChild(parent, node?.stateNode);\r\n        }\r\n        else if (node.child !== null) {\r\n            // 如果没有要找的元素类型，也向下找\r\n            // A 组件里还有 child\r\n            node.child.return = node;\r\n            node = node.child;\r\n            continue;\r\n        }\r\n        // 归的阶段，回归到了本节点\r\n        if (node === wip) {\r\n            return;\r\n        }\r\n        // 向下找到头了，就开始向上找\r\n        while (node.sibling == null) {\r\n            // 往上归\r\n            if (node.return === null || node.return === wip) {\r\n                return;\r\n            }\r\n            node = node?.return;\r\n        }\r\n        // 建立联系\r\n        node.sibling.return = node.return;\r\n        node = node.sibling;\r\n    }\r\n}\r\n// completeWork性能优化策略：利用completeWork向上归的过程\r\n// 将子fiberNode的flags冒泡到父fiberNode\r\nfunction bubblePropertied(wip) {\r\n    let subtreeFlags = NoFlags;\r\n    let child = wip.child;\r\n    while (child !== null) {\r\n        // 将子节点的副作用标记集成到当前节点的副作用标识中\r\n        subtreeFlags |= child.subtreeFlags;\r\n        subtreeFlags |= child.flags;\r\n        // 把当前节点的子节点和父节点联系起来\r\n        child.return = wip;\r\n        child = child.sibling;\r\n    }\r\n    // 将遍历到的所有 subtreeFlags 附加在当前 wip 的 subtreeFlags 上\r\n    wip.subtreeFlags |= subtreeFlags;\r\n}\r\n//# sourceMappingURL=completeWork.js.map","references":["/Users/liangshuhao/Learn/coderwhy/Learn React/Big-React18-/big-react18/packages/react-reconciler/src/fiberFlags.ts","/Users/liangshuhao/Learn/coderwhy/Learn React/Big-React18-/big-react18/packages/react-dom/src/hostConfig.ts","/Users/liangshuhao/Learn/coderwhy/Learn React/Big-React18-/big-react18/packages/react-reconciler/src/workTags.ts","/Users/liangshuhao/Learn/coderwhy/Learn React/Big-React18-/big-react18/packages/react-reconciler/src/fiber.ts"],"map":"{\"version\":3,\"file\":\"completeWork.js\",\"sourceRoot\":\"\",\"sources\":[\"../../../../packages/react-reconciler/src/completeWork.ts\"],\"names\":[],\"mappings\":\"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\"}"}
